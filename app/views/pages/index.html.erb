<h2>Demonstration Animated Heat Map</h2>
<div id="chart"></div>
<a href="#" id="start_map">Start Map</a>
<h3 id="year">2012</h3>
<script type="text/javascript" charset="utf-8">
  var data; // loaded asynchronously

  var path = d3.geo.path();

  var svg = d3.select("#chart")
    .append("svg");

  var counties = svg.append("g")
      .attr("id", "counties")
      .attr("class", "Blues");

  var states = svg.append("g")
      .attr("id", "states");

  d3.json("/pages/counties.json", function(json) {
    counties.selectAll("path")
        .data(json.features)
      .enter().append("path")
        .attr("class", data ? quantize : null)
        .attr("d", path);
  });

  d3.json("/pages/states.json", function(json) {
    states.selectAll("path")
        .data(json.features)
      .enter().append("path")
        .attr("d", path);
  });

  d3.json("/pages/data.json", function(json) {
    data = json;
    counties.selectAll("path")
        .attr("class", quantize);
  });

  function quantize(d) {
    return "q" + Math.min(8, ~~(data[d.id] * 9 / 12)) + "-9";
  }

  function heatMap(){
    var i = 0;
    var interval = setInterval(
      function(){
       // change the data
       var new_json = {}
       $.map(data,function(val, key){
         new_json[key] = (val * (1 + (Math.random() * (0.15 - 0.05) + 0.05)));
       });
       data = new_json;
       // update the map
       counties.selectAll("path")
           .attr("class", quantize);
       // 
       console.log(i);
       i++;
       $('#year').html(2012 + i)
       if (i >= 20) {clearInterval(interval)};
      }, 1000);
  }

  function heatMapOnce(){
    var new_json = {}
     $.map(data,function(val, key){
       new_json[key] = (val * (1 - (Math.random() * (0.3 - 0.05) + 0.05)));
     });
     data = new_json;
     // update the map
     counties.selectAll("path")
         .attr("class", quantize);
  }
  
  $('#start_map').on("click", function(e){
    heatMap();
    e.preventDefault();
  });
</script>